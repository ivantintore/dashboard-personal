# Caddyfile - Dashboard Personal Ivan Tintore
# Autenticación con Google OAuth2 via Auth Service

keonycs.com, www.keonycs.com {
    # Health check sin auth (para monitoreo)
    @health path /health
    handle @health {
        respond "OK" 200
    }

    # ========== AUTH SERVICE (sin protección) ==========
    handle /auth/* {
        reverse_proxy auth-service:8080
    }

    # ========== RUTAS PROTEGIDAS ==========
    # Todas las rutas siguientes requieren autenticación
    
    @protected {
        not path /auth/*
        not path /health
    }

    handle @protected {
        # Verificar sesión con auth-service
        forward_auth auth-service:8080 {
            uri /auth/verify
            copy_headers X-Auth-User X-Auth-Name X-Auth-Role
        }

        # Dashboard principal
        handle /tools {
            redir /tools/ permanent
        }
        handle /tools/* {
            uri strip_prefix /tools
            reverse_proxy dashboard-web:3000
        }

        # Conversor HEIF - FastAPI
        handle /conversor {
            redir /conversor/ permanent
        }
        handle /conversor/* {
            uri strip_prefix /conversor
            reverse_proxy conversor:8000
        }

        # AEAT API - FastAPI
        handle /aeat {
            redir /aeat/ permanent
        }
        handle /aeat/* {
            uri strip_prefix /aeat
            reverse_proxy aeat-api:8000
        }

        # AEAT Dashboard - Streamlit
        handle /aeat-ui {
            redir /aeat-ui/ permanent
        }
        handle /aeat-ui/* {
            uri strip_prefix /aeat-ui
            reverse_proxy aeat-dashboard:8501
        }

        # Intrastat Manager - Node serve
        handle /intrastat {
            redir /intrastat/ permanent
        }
        handle /intrastat/* {
            uri strip_prefix /intrastat
            reverse_proxy intrastat:3001
        }

        # Taxi Management - Node + SQLite
        handle /taxi {
            redir /taxi/ permanent
        }
        handle /taxi/* {
            uri strip_prefix /taxi
            reverse_proxy taxi:3003
        }

        # Adela Finanzas - Node + SQLite
        handle /adela {
            redir /adela/ permanent
        }
        handle /adela/* {
            uri strip_prefix /adela
            reverse_proxy adela:3002
        }

        # Toroidal Propellers - Flask
        handle /toroidal {
            redir /toroidal/ permanent
        }
        handle /toroidal/* {
            uri strip_prefix /toroidal
            reverse_proxy toroidal:5001
        }

        # Flower Monitor - Celery
        handle /flower {
            redir /flower/ permanent
        }
        handle /flower/* {
            uri strip_prefix /flower
            reverse_proxy aeat-flower:5555
        }

        # Admin panel (solo para admins, pero verificación en auth-service)
        handle /admin {
            redir /auth/admin permanent
        }

        # Root -> redirect to login or dashboard
        handle {
            redir /tools/ permanent
        }
    }

    # Logs
    log {
        output stdout
        format console
    }
}

# Redirect www to non-www
www.keonycs.com {
    redir https://keonycs.com{uri} permanent
}
