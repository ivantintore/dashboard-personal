# Caddyfile - Dashboard Personal Ivan Tintore
# Enterprise Security Configuration
# Autenticación con Google OAuth2 via Auth Service

keonycs.com, www.keonycs.com {
    # ========== SECURITY HEADERS (Global) ==========
    header {
        # HSTS - Force HTTPS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # Prevent clickjacking
        X-Frame-Options "DENY"
        
        # XSS Protection
        X-XSS-Protection "1; mode=block"
        
        # Referrer Policy
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' wss: https:; frame-ancestors 'none'"
        
        # Permissions Policy
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        
        # Remove server header
        -Server
    }

    # Health check sin auth (para monitoreo)
    @health path /health
    handle @health {
        respond "OK" 200
    }

    # ========== AUTH SERVICE (sin protección) ==========
    handle /auth/* {
        reverse_proxy auth-service:8080
    }

    # ========== RUTAS PROTEGIDAS ==========
    # Todas las rutas siguientes requieren autenticación
    
    @protected {
        not path /auth/*
        not path /health
    }

    handle @protected {
        # Verificar sesión con auth-service
        forward_auth auth-service:8080 {
            uri /auth/verify
            copy_headers X-Auth-User X-Auth-Name X-Auth-Role
        }

        # Dashboard principal
        handle /tools {
            redir /tools/ permanent
        }
        handle /tools/* {
            uri strip_prefix /tools
            reverse_proxy dashboard-web:3000
        }

        # Conversor HEIF - FastAPI
        handle /conversor {
            redir /conversor/ permanent
        }
        handle /conversor/* {
            uri strip_prefix /conversor
            reverse_proxy conversor:8000
        }

        # AEAT API - FastAPI
        handle /aeat {
            redir /aeat/ permanent
        }
        handle /aeat/* {
            uri strip_prefix /aeat
            reverse_proxy aeat-api:8000
        }

        # AEAT Dashboard - Streamlit
        handle /aeat-ui {
            redir /aeat-ui/ permanent
        }
        handle /aeat-ui/* {
            uri strip_prefix /aeat-ui
            reverse_proxy aeat-dashboard:8501
        }

        # Intrastat Manager - Node serve
        handle /intrastat {
            redir /intrastat/ permanent
        }
        handle /intrastat/* {
            uri strip_prefix /intrastat
            reverse_proxy intrastat:3001
        }

        # Taxi Management - Node + SQLite
        handle /taxi {
            redir /taxi/ permanent
        }
        handle /taxi/* {
            uri strip_prefix /taxi
            reverse_proxy taxi:3003
        }

        # Adela Finanzas - Node + SQLite
        handle /adela {
            redir /adela/ permanent
        }
        handle /adela/* {
            uri strip_prefix /adela
            reverse_proxy adela:3002
        }

        # Toroidal Propellers - Flask
        handle /toroidal {
            redir /toroidal/ permanent
        }
        handle /toroidal/* {
            uri strip_prefix /toroidal
            reverse_proxy toroidal:5001
        }

        # Flower Monitor - Celery (ADMIN ONLY)
        handle /flower {
            redir /flower/ permanent
        }
        handle /flower/* {
            # Restrict to admin role only
            @not_admin {
                not header X-Auth-Role admin
            }
            respond @not_admin "Access Denied - Admin Only" 403
            
            uri strip_prefix /flower
            reverse_proxy aeat-flower:5555
        }

        # Admin panel (solo para admins, pero verificación en auth-service)
        handle /admin {
            redir /auth/admin permanent
        }

        # Root -> redirect to login or dashboard
        handle {
            redir /tools/ permanent
        }
    }

    # Logs
    log {
        output stdout
        format json
        level INFO
    }
}

# Redirect www to non-www
www.keonycs.com {
    redir https://keonycs.com{uri} permanent
}
