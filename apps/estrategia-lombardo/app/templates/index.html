<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estrategia Lombardo | Deuda-Rentabilidad</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">‚óà</span>
                <span class="logo-text">Estrategia Lombardo</span>
            </div>
            <nav class="nav">
                <a href="#estudio-1" class="nav-link active" data-section="1">Cr√©dito Lombardo</a>
                <a href="#estudio-2" class="nav-link" data-section="2">Activo Colateral</a>
                <a href="#estudio-3" class="nav-link" data-section="3">Inversi√≥n</a>
                <a href="#estrategia" class="nav-link" data-section="4">Estrategia Completa</a>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Hero Section with Global Params -->
            <section class="hero">
                <div class="hero-content">
                    <h1>An√°lisis de Apalancamiento con Pr√©stamo Lombardo</h1>
                    <p>Eval√∫a la estrategia: Comprar acciones ‚Üí Pr√©stamo sobre acciones ‚Üí Invertir el pr√©stamo</p>
                </div>
                <div class="global-params">
                    <div class="param-group">
                        <label>Capital Inicial</label>
                        <div class="input-wrapper">
                            <span class="currency">‚Ç¨</span>
                            <input type="number" id="capital-inicial" value="100000" step="10000">
                        </div>
                    </div>
                    <div class="param-group">
                        <label>Euribor 12M</label>
                        <div class="input-wrapper">
                            <input type="number" id="euribor" value="2.5" step="0.1">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    <button class="btn-calculate" onclick="calcularTodo()">
                        <span>Calcular Todo</span>
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <!-- Estudio 1: Cr√©dito Lombardo -->
            <section id="estudio-1" class="section">
                <div class="section-header">
                    <div class="section-number">01</div>
                    <div class="section-title">
                        <h2>Cr√©dito Lombardo</h2>
                        <p>Costes y condiciones del pr√©stamo garantizado con valores</p>
                    </div>
                </div>

                <div class="cards-grid">
                    <!-- Par√°metros del Lombardo -->
                    <div class="card params-card">
                        <h3>Par√°metros del Pr√©stamo</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>LTV (Loan-to-Value)</label>
                                <div class="input-wrapper">
                                    <input type="range" id="ltv" min="50" max="80" value="70" oninput="updateLtvDisplay()">
                                    <span id="ltv-display" class="range-value">70%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Spread sobre Euribor</label>
                                <div class="input-wrapper">
                                    <input type="number" id="spread-lombardo" value="1.5" step="0.1">
                                    <span class="suffix">%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resultado Principal -->
                    <div class="card result-card highlight">
                        <div class="result-header">
                            <span class="result-label">Capital del Pr√©stamo</span>
                            <span id="lombardo-capital" class="result-value">70.000 ‚Ç¨</span>
                        </div>
                        <div class="result-details">
                            <div class="detail">
                                <span class="detail-label">TIN</span>
                                <span id="lombardo-tin" class="detail-value">4.00%</span>
                            </div>
                            <div class="detail">
                                <span class="detail-label">Coste Mensual</span>
                                <span id="lombardo-mensual" class="detail-value">233 ‚Ç¨</span>
                            </div>
                            <div class="detail">
                                <span class="detail-label">Coste Anual</span>
                                <span id="lombardo-anual" class="detail-value">2.800 ‚Ç¨</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gastos Iniciales -->
                    <div class="card">
                        <h3>Gastos Iniciales</h3>
                        <div class="breakdown">
                            <div class="breakdown-item">
                                <span>Comisi√≥n apertura (0.5%)</span>
                                <span id="lombardo-comision">350 ‚Ç¨</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Estudio</span>
                                <span id="lombardo-estudio">150 ‚Ç¨</span>
                            </div>
                            <div class="breakdown-item total">
                                <span>Total</span>
                                <span id="lombardo-gastos-total">500 ‚Ç¨</span>
                            </div>
                        </div>
                    </div>

                    <!-- Margin Call -->
                    <div class="card warning-card">
                        <h3>‚ö†Ô∏è An√°lisis de Margin Call</h3>
                        <div class="margin-call-info">
                            <p>Si las acciones caen un <strong id="caida-margin">17.6%</strong>, recibir√°s un <span class="tag warning">Margin Call</span></p>
                            <p>Si caen un <strong id="caida-liquidacion">26.3%</strong>, el banco <span class="tag danger">liquidar√° tus acciones</span></p>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-labels">
                                <span>Actual: 70%</span>
                                <span id="margin-call-ltv">Margin: 85%</span>
                                <span id="liquidacion-ltv">Liquid: 95%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="progress-actual" class="progress-fill" style="width: 70%;"></div>
                                <div class="progress-marker margin" style="left: 85%;"></div>
                                <div class="progress-marker liquidation" style="left: 95%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NUEVO: Stress Test -->
                <div class="stress-test-section">
                    <div class="stress-header">
                        <h3>üõ°Ô∏è Stress Test: ¬øCu√°nta ca√≠da puedes soportar?</h3>
                        <p>Basado en datos hist√≥ricos del S&P 500 (1950-2024). El 80% de los a√±os acaban positivos, pero casi todos tienen ca√≠das intra-anuales significativas.</p>
                    </div>
                    
                    <div class="stress-controls">
                        <div class="stress-selector">
                            <label>¬øQu√© drawdown quieres poder tolerar?</label>
                            <select id="drawdown-tolerado" onchange="calcularStressTest()">
                                <option value="0.20">-20% (Correcci√≥n fuerte)</option>
                                <option value="0.30" selected>-30% (Crisis moderada como COVID)</option>
                                <option value="0.40">-40% (Crisis severa)</option>
                                <option value="0.50">-50% (Crash total como 2008)</option>
                            </select>
                        </div>
                        <div class="stress-result-box">
                            <span class="stress-result-label">LTV M√°ximo Recomendado</span>
                            <span id="ltv-maximo-seguro" class="stress-result-value">60%</span>
                            <span class="stress-result-desc">Para tolerar <span id="drawdown-seleccionado">-30%</span> sin margin call</span>
                        </div>
                    </div>

                    <div class="stress-comparison">
                        <div class="stress-your-config">
                            <h4>Tu Configuraci√≥n Actual</h4>
                            <div class="config-details">
                                <div class="config-item">
                                    <span>LTV Actual</span>
                                    <span id="stress-ltv-actual" class="config-value">70%</span>
                                </div>
                                <div class="config-item">
                                    <span>Drawdown Tolerable</span>
                                    <span id="stress-drawdown-real" class="config-value">-17.6%</span>
                                </div>
                                <div class="config-item">
                                    <span id="stress-veredicto" class="veredicto warning">‚ö†Ô∏è Riesgo Moderado</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stress-escenarios">
                        <h4>üìä Simulaci√≥n de Crisis Hist√≥ricas</h4>
                        <p class="escenarios-desc">¬øQu√© pasar√≠a con tu pr√©stamo en cada escenario?</p>
                        <div class="escenarios-grid" id="escenarios-crisis-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="stress-recomendacion" id="stress-recomendacion">
                        <span class="reco-icon">üí°</span>
                        <span class="reco-text">Cargando recomendaci√≥n...</span>
                    </div>
                </div>

                <!-- Comparativa Hipoteca vs Lombardo -->
                <div class="comparison-section">
                    <h3>Comparativa: Hipoteca vs Lombardo</h3>
                    <div class="comparison-table">
                        <div class="comparison-column">
                            <div class="column-header hipoteca">
                                <span class="column-icon">üè†</span>
                                <span>Hipoteca</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">TIN</span>
                                <span id="hipoteca-tin" class="item-value">3.50%</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">Cuota Mensual</span>
                                <span id="hipoteca-cuota" class="item-value">350 ‚Ç¨</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">Gastos Iniciales</span>
                                <span id="hipoteca-gastos" class="item-value">3.500 ‚Ç¨</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">Garant√≠a</span>
                                <span class="item-value">Inmueble</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">Amortizaci√≥n</span>
                                <span class="item-value">S√≠ (mensual)</span>
                            </div>
                        </div>
                        <div class="comparison-column">
                            <div class="column-header lombardo">
                                <span class="column-icon">üìà</span>
                                <span>Lombardo</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">TIN</span>
                                <span id="lombardo-tin-comp" class="item-value">4.00%</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">Cuota Mensual</span>
                                <span id="lombardo-cuota-comp" class="item-value">233 ‚Ç¨</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">Gastos Iniciales</span>
                                <span id="lombardo-gastos-comp" class="item-value">500 ‚Ç¨</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">Garant√≠a</span>
                                <span class="item-value">Valores</span>
                            </div>
                            <div class="comparison-item">
                                <span class="item-label">Amortizaci√≥n</span>
                                <span class="item-value">No (bullet)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Estudio 2: Activo Colateral - IBEX 35 -->
            <section id="estudio-2" class="section">
                <div class="section-header">
                    <div class="section-number">02</div>
                    <div class="section-title">
                        <h2>Activo Colateral</h2>
                        <p>An√°lisis de los valores del IBEX 35 como garant√≠a (datos 5 a√±os)</p>
                    </div>
                </div>

                <!-- Selector de Sector -->
                <div class="sector-selector">
                    <h3>Filtrar por Sector</h3>
                    <div class="sector-buttons" id="sector-buttons">
                        <button class="sector-btn active" data-sector="todos">
                            <span>üìä Todos</span>
                        </button>
                        <button class="sector-btn" data-sector="Banca">
                            <span>üè¶ Banca</span>
                        </button>
                        <button class="sector-btn" data-sector="Utilities">
                            <span>‚ö° Utilities</span>
                        </button>
                        <button class="sector-btn" data-sector="Energ√≠as Renovables">
                            <span>üå± Renovables</span>
                        </button>
                        <button class="sector-btn" data-sector="Infraestructuras">
                            <span>üèóÔ∏è Infraestructuras</span>
                        </button>
                        <button class="sector-btn" data-sector="Telecomunicaciones">
                            <span>üì° Telecom</span>
                        </button>
                        <button class="sector-btn" data-sector="Retail">
                            <span>üõí Retail</span>
                        </button>
                    </div>
                </div>

                <!-- Top Valores por Yield -->
                <div class="top-valores-section">
                    <h3>Top Valores IBEX 35 por Rentabilidad por Dividendo</h3>
                    <div class="top-valores-grid" id="top-valores-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="cards-grid cards-grid-3">
                    <!-- Info del Activo Seleccionado -->
                    <div class="card activo-card">
                        <div class="activo-header">
                            <div class="activo-icon">üìà</div>
                            <div class="activo-info">
                                <h3 id="activo-nombre">Selecciona un valor</h3>
                                <span id="activo-ticker" class="activo-ticker">-</span>
                            </div>
                            <div id="activo-precio" class="activo-precio">- ‚Ç¨</div>
                        </div>
                        <div class="activo-stats">
                            <div class="stat">
                                <span class="stat-label">N¬∫ Acciones</span>
                                <span id="activo-acciones" class="stat-value">-</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Sector</span>
                                <span id="activo-sector" class="stat-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Dividendos con Hist√≥rico -->
                    <div class="card dividend-card highlight">
                        <h3>An√°lisis de Dividendos (5 a√±os)</h3>
                        <div class="dividend-main">
                            <div class="dividend-yield">
                                <span class="yield-label">Yield Actual</span>
                                <span id="activo-yield" class="yield-value">-</span>
                            </div>
                            <div class="dividend-amount">
                                <span id="dividendos-anuales" class="amount-value">- ‚Ç¨</span>
                                <span class="amount-label">/ a√±o</span>
                            </div>
                        </div>
                        <div class="dividend-breakdown">
                            <div class="breakdown-item">
                                <span>Crecimiento 5 a√±os (CAGR)</span>
                                <span id="dividendo-cagr" class="cagr-value">-</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Consistencia</span>
                                <span id="dividendo-consistencia" class="consistencia-badge">-</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Dividendo por acci√≥n</span>
                                <span id="dividendo-accion">- ‚Ç¨</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Mensual estimado</span>
                                <span id="dividendos-mensuales">- ‚Ç¨</span>
                            </div>
                        </div>
                    </div>

                    <!-- Riesgo y LTV -->
                    <div class="card risk-card">
                        <h3>Perfil de Riesgo</h3>
                        <div class="risk-metrics">
                            <div class="risk-item">
                                <span class="risk-label">Volatilidad Anual</span>
                                <span id="activo-volatilidad" class="risk-value">-</span>
                            </div>
                            <div class="risk-item">
                                <span class="risk-label">Beta</span>
                                <span id="activo-beta" class="risk-value">-</span>
                            </div>
                            <div class="risk-item">
                                <span class="risk-label">Max Drawdown 5Y</span>
                                <span id="activo-drawdown" class="risk-value">-</span>
                            </div>
                            <div class="risk-item">
                                <span class="risk-label">LTV Recomendado</span>
                                <span id="activo-ltv-rec" class="risk-value highlight">-</span>
                            </div>
                        </div>
                        <div class="potential-main" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div class="potential-item">
                                <span class="potential-label">Pr√©stamo M√°ximo</span>
                                <span id="prestamo-maximo" class="potential-value">- ‚Ç¨</span>
                            </div>
                            <div class="potential-item">
                                <span class="potential-label">Margen de Seguridad</span>
                                <span id="margen-seguridad" class="potential-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Dividendos Hist√≥ricos -->
                <div class="historico-section">
                    <h3>üìä Evoluci√≥n de Dividendos (2019-2023)</h3>
                    <div class="historico-chart-container">
                        <canvas id="dividendos-chart"></canvas>
                    </div>
                </div>

                <!-- Ranking Completo IBEX 35 -->
                <div class="ranking-section">
                    <h3>Ranking IBEX 35 por Rentabilidad por Dividendo</h3>
                    <div class="ranking-controls">
                        <span id="ranking-count">35 valores</span>
                    </div>
                    <div class="ranking-table-container">
                        <table class="ranking-table-full" id="ranking-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Valor</th>
                                    <th>Sector</th>
                                    <th>Yield</th>
                                    <th>CAGR 5Y</th>
                                    <th>Consistencia</th>
                                    <th>LTV Rec.</th>
                                    <th>Pr√©stamo/100K</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-tbody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Estudio 3: Inversi√≥n -->
            <section id="estudio-3" class="section">
                <div class="section-header">
                    <div class="section-number">03</div>
                    <div class="section-title">
                        <h2>Inversi√≥n del Pr√©stamo</h2>
                        <p>¬øEn qu√© invertir el dinero del pr√©stamo para que rinda m√°s que el coste?</p>
                    </div>
                </div>

                <div class="spread-indicator">
                    <div class="spread-info">
                        <span class="spread-label">Coste del Pr√©stamo</span>
                        <span id="coste-referencia" class="spread-value negative">4.00%</span>
                    </div>
                    <div class="spread-arrow">‚Üí</div>
                    <div class="spread-info">
                        <span class="spread-label">M√≠nimo Necesario</span>
                        <span class="spread-value">Para ser rentable, necesitas &gt; <span id="minimo-rentable">4.00%</span></span>
                    </div>
                </div>

                <div class="opciones-grid" id="opciones-inversion">
                    <!-- Populated by JS -->
                </div>

                <!-- Escenarios -->
                <div class="escenarios-section">
                    <h3>An√°lisis de Escenarios (¬øQu√© pasa si cambia el Euribor?)</h3>
                    <div class="escenarios-chart">
                        <canvas id="escenarios-chart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Estrategia Completa -->
            <section id="estrategia" class="section">
                <div class="section-header">
                    <div class="section-number">‚àë</div>
                    <div class="section-title">
                        <h2>Estrategia Completa</h2>
                        <p>Resultado final combinando los 3 estudios</p>
                    </div>
                </div>

                <div class="strategy-flow">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Capital Inicial</h4>
                            <span id="flow-capital" class="step-value">100.000 ‚Ç¨</span>
                            <span class="step-desc">Compras acciones</span>
                        </div>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Pr√©stamo Lombardo</h4>
                            <span id="flow-prestamo" class="step-value">70.000 ‚Ç¨</span>
                            <span class="step-desc">70% LTV</span>
                        </div>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Inversi√≥n</h4>
                            <span id="flow-inversion" class="step-value">70.000 ‚Ç¨</span>
                            <span class="step-desc">En activo seleccionado</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid resultado-grid">
                    <!-- Ingresos -->
                    <div class="card ingresos-card">
                        <h3>üí∞ Ingresos Anuales</h3>
                        <div class="resultado-breakdown">
                            <div class="resultado-item positive">
                                <span class="resultado-label">Dividendos de acciones</span>
                                <span id="resultado-dividendos" class="resultado-value">+7.000 ‚Ç¨</span>
                            </div>
                            <div class="resultado-item positive">
                                <span class="resultado-label">Rentabilidad inversi√≥n</span>
                                <span id="resultado-rentabilidad" class="resultado-value">+2.450 ‚Ç¨</span>
                            </div>
                            <div class="resultado-item total positive">
                                <span class="resultado-label">Total Ingresos</span>
                                <span id="resultado-ingresos" class="resultado-value">+9.450 ‚Ç¨</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gastos -->
                    <div class="card gastos-card">
                        <h3>üìâ Gastos Anuales</h3>
                        <div class="resultado-breakdown">
                            <div class="resultado-item negative">
                                <span class="resultado-label">Coste pr√©stamo lombardo</span>
                                <span id="resultado-coste" class="resultado-value">-2.800 ‚Ç¨</span>
                            </div>
                            <div class="resultado-item total negative">
                                <span class="resultado-label">Total Gastos</span>
                                <span id="resultado-gastos" class="resultado-value">-2.800 ‚Ç¨</span>
                            </div>
                        </div>
                    </div>

                    <!-- Resultado Final -->
                    <div class="card final-card highlight">
                        <h3>üìä Resultado Neto</h3>
                        <div class="final-result">
                            <div class="final-main">
                                <span id="resultado-neto" class="final-value positive">+6.650 ‚Ç¨</span>
                                <span class="final-label">beneficio neto / a√±o</span>
                            </div>
                            <div class="final-metrics">
                                <div class="metric">
                                    <span class="metric-label">ROI sobre capital</span>
                                    <span id="resultado-roi" class="metric-value">6.65%</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Sin apalancamiento</span>
                                    <span id="resultado-sin-apalancamiento" class="metric-value">7.00%</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Mejora</span>
                                    <span id="resultado-mejora" class="metric-value">-0.35%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Proyecci√≥n a 5 a√±os -->
                <div class="proyeccion-section">
                    <h3>Proyecci√≥n a 5 A√±os</h3>
                    <div class="proyeccion-chart">
                        <canvas id="proyeccion-chart"></canvas>
                    </div>
                    <div class="proyeccion-summary">
                        <div class="summary-item">
                            <span class="summary-label">Beneficio Total (5 a√±os)</span>
                            <span id="beneficio-5-a√±os" class="summary-value">33.250 ‚Ç¨</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">ROI Total</span>
                            <span id="roi-5-a√±os" class="summary-value">33.25%</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">ROI Anualizado</span>
                            <span id="roi-anualizado" class="summary-value">6.65%</span>
                        </div>
                    </div>
                </div>

                <!-- Advertencias -->
                <div class="warnings-section">
                    <h3>‚ö†Ô∏è Riesgos a Considerar</h3>
                    <div class="warnings-grid">
                        <div class="warning-item">
                            <span class="warning-icon">üìâ</span>
                            <div class="warning-content">
                                <strong>Margin Call</strong>
                                <p>Si las acciones caen significativamente, deber√°s aportar m√°s garant√≠as o vender.</p>
                            </div>
                        </div>
                        <div class="warning-item">
                            <span class="warning-icon">üìà</span>
                            <div class="warning-content">
                                <strong>Riesgo de Tipos</strong>
                                <p>Si sube el Euribor, aumenta el coste del pr√©stamo y puede comerse el beneficio.</p>
                            </div>
                        </div>
                        <div class="warning-item">
                            <span class="warning-icon">üí∞</span>
                            <div class="warning-content">
                                <strong>Dividendos</strong>
                                <p>Los dividendos no est√°n garantizados y pueden reducirse o eliminarse.</p>
                            </div>
                        </div>
                        <div class="warning-item">
                            <span class="warning-icon">üîÑ</span>
                            <div class="warning-content">
                                <strong>Renovaci√≥n</strong>
                                <p>El pr√©stamo lombardo debe renovarse peri√≥dicamente. El banco puede no renovar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>Esta herramienta es solo para fines educativos. Consulta con un asesor financiero antes de tomar decisiones de inversi√≥n.</p>
        </footer>
    </div>

    <script>
        // ====================================
        // GLOBAL STATE
        // ====================================
        let state = {
            capitalInicial: 100000,
            euribor: 0.025,
            ltv: 0.70,
            spreadLombardo: 0.015,
            tickerActivo: 'BBVA.MC',
            yieldActivo: 0.07,
            rentabilidadInversion: 0.035
        };

        let charts = {
            escenarios: null,
            proyeccion: null,
            dividendos: null
        };

        let ibexData = []; // Cache de datos IBEX 35

        // ====================================
        // INITIALIZATION
        // ====================================
        document.addEventListener('DOMContentLoaded', () => {
            initNavigation();
            initSectorSelector();
            calcularTodo();
        });

        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });
        }

        function initSectorSelector() {
            const buttons = document.querySelectorAll('.sector-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const sector = btn.dataset.sector;
                    filtrarPorSector(sector);
                });
            });
        }

        async function filtrarPorSector(sector) {
            try {
                let url = 'api/activos/ibex35';
                if (sector && sector !== 'todos') {
                    url = `api/activos/sector/${encodeURIComponent(sector)}`;
                }
                
                const response = await fetch(url);
                ibexData = await response.json();
                
                renderTopValores(ibexData);
                renderRankingTable(ibexData);
                document.getElementById('ranking-count').textContent = `${ibexData.length} valores`;
                
                // Seleccionar el primero si hay datos
                if (ibexData.length > 0) {
                    seleccionarValor(ibexData[0].activo.ticker);
                }
            } catch (error) {
                console.error('Error filtrando por sector:', error);
            }
        }

        // ====================================
        // MAIN CALCULATION
        // ====================================
        async function calcularTodo() {
            updateStateFromInputs();
            await Promise.all([
                calcularLombardo(),
                calcularActivo(),
                calcularInversion(),
                calcularComparativa(),
                calcularStressTest()
            ]);
            await calcularEstrategia();
        }

        function updateStateFromInputs() {
            state.capitalInicial = parseFloat(document.getElementById('capital-inicial').value) || 100000;
            state.euribor = (parseFloat(document.getElementById('euribor').value) || 2.5) / 100;
            state.ltv = (parseFloat(document.getElementById('ltv').value) || 70) / 100;
            state.spreadLombardo = (parseFloat(document.getElementById('spread-lombardo').value) || 1.5) / 100;
        }

        function updateLtvDisplay() {
            const ltv = document.getElementById('ltv').value;
            document.getElementById('ltv-display').textContent = ltv + '%';
            state.ltv = ltv / 100;
            calcularLombardo();
            calcularEstrategia();
        }

        // ====================================
        // STRESS TEST
        // ====================================
        async function calcularStressTest() {
            try {
                const drawdownTolerado = parseFloat(document.getElementById('drawdown-tolerado').value);
                
                const params = new URLSearchParams({
                    valor_colateral: state.capitalInicial,
                    ltv_actual: state.ltv,
                    drawdown_tolerado: drawdownTolerado
                });
                
                const response = await fetch(`api/stress-test/analizar?${params}`);
                const data = await response.json();
                
                // Actualizar UI - LTV m√°ximo seguro
                document.getElementById('ltv-maximo-seguro').textContent = data.analisis.ltv_maximo_seguro_pct;
                document.getElementById('drawdown-seleccionado').textContent = `-${drawdownTolerado * 100}%`;
                
                // Tu configuraci√≥n
                document.getElementById('stress-ltv-actual').textContent = data.configuracion.ltv_actual_pct;
                document.getElementById('stress-drawdown-real').textContent = data.analisis.drawdown_real_tolerable_pct;
                
                // Veredicto
                const veredictoEl = document.getElementById('stress-veredicto');
                const drawdownReal = data.analisis.drawdown_real_tolerable;
                
                if (drawdownReal >= 0.30) {
                    veredictoEl.textContent = '‚úÖ Configuraci√≥n Segura';
                    veredictoEl.className = 'veredicto seguro';
                } else if (drawdownReal >= 0.20) {
                    veredictoEl.textContent = 'üìä Riesgo Moderado';
                    veredictoEl.className = 'veredicto moderado';
                } else if (drawdownReal >= 0.10) {
                    veredictoEl.textContent = '‚ö†Ô∏è Riesgo Alto';
                    veredictoEl.className = 'veredicto warning';
                } else {
                    veredictoEl.textContent = 'üö® Riesgo Muy Alto';
                    veredictoEl.className = 'veredicto danger';
                }
                
                // Renderizar escenarios de crisis
                const escGrid = document.getElementById('escenarios-crisis-grid');
                escGrid.innerHTML = data.escenarios_crisis.map(esc => `
                    <div class="escenario-card ${esc.clase}">
                        <div class="escenario-header">
                            <span class="escenario-nombre">${esc.crisis}</span>
                            <span class="escenario-a√±o">${esc.a√±o_referencia}</span>
                        </div>
                        <div class="escenario-drawdown">${esc.drawdown}</div>
                        <div class="escenario-resultado">
                            <div class="resultado-ltv">
                                <span>LTV resultante:</span>
                                <span class="ltv-value ${esc.clase}">${esc.ltv_resultante_pct}</span>
                            </div>
                            <div class="resultado-estado">${esc.estado}</div>
                            ${esc.capital_adicional_necesario > 0 ? `
                                <div class="capital-necesario">
                                    <small>Capital adicional: ${formatCurrency(esc.capital_adicional_necesario)}</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
                
                // Recomendaci√≥n
                const recoEl = document.getElementById('stress-recomendacion');
                recoEl.innerHTML = `
                    <span class="reco-icon">üí°</span>
                    <span class="reco-text">${data.resumen.recomendacion} 
                    Sobrevives ${data.resumen.escenarios_que_sobrevives}/${data.resumen.total_escenarios} escenarios.
                    Peor crisis que toleras: <strong>${data.resumen.peor_escenario_seguro}</strong>.</span>
                `;
                
            } catch (error) {
                console.error('Error calculando stress test:', error);
            }
        }

        // ====================================
        // ESTUDIO 1: LOMBARDO
        // ====================================
        async function calcularLombardo() {
            try {
                const params = new URLSearchParams({
                    valor_garantia: state.capitalInicial,
                    ltv: state.ltv,
                    euribor: state.euribor,
                    spread: state.spreadLombardo
                });
                
                const response = await fetch(`api/lombardo/calcular?${params}`);
                const data = await response.json();
                
                // Update UI
                document.getElementById('lombardo-capital').textContent = formatCurrency(data.prestamo.capital_prestado);
                document.getElementById('lombardo-tin').textContent = data.costes.tin_anual;
                document.getElementById('lombardo-mensual').textContent = formatCurrency(data.costes.coste_mensual);
                document.getElementById('lombardo-anual').textContent = formatCurrency(data.costes.intereses_anuales);
                document.getElementById('lombardo-comision').textContent = formatCurrency(data.costes.comision_apertura);
                document.getElementById('lombardo-estudio').textContent = '150 ‚Ç¨';
                document.getElementById('lombardo-gastos-total').textContent = formatCurrency(data.costes.gastos_totales_inicio);
                
                // Margin call
                document.getElementById('caida-margin').textContent = data.riesgo.caida_hasta_margin_call;
                document.getElementById('caida-liquidacion').textContent = data.riesgo.caida_hasta_liquidacion;
                
                // Progress bar
                const ltvPercent = state.ltv * 100;
                document.getElementById('progress-actual').style.width = `${ltvPercent}%`;
                
                // Comparison
                document.getElementById('lombardo-tin-comp').textContent = data.costes.tin_anual;
                document.getElementById('lombardo-cuota-comp').textContent = formatCurrency(data.costes.coste_mensual);
                document.getElementById('lombardo-gastos-comp').textContent = formatCurrency(data.costes.gastos_totales_inicio);
                
            } catch (error) {
                console.error('Error calculando lombardo:', error);
            }
        }

        // ====================================
        // ESTUDIO 2: ACTIVO - IBEX 35
        // ====================================
        async function calcularActivo() {
            try {
                // Cargar todos los valores del IBEX 35
                const response = await fetch(`api/activos/ibex35?inversion=${state.capitalInicial}`);
                ibexData = await response.json();
                
                // Render top valores y ranking
                renderTopValores(ibexData);
                renderRankingTable(ibexData);
                document.getElementById('ranking-count').textContent = `${ibexData.length} valores`;
                
                // Seleccionar el primero o el actual
                const currentTicker = state.tickerActivo || (ibexData[0]?.activo?.ticker);
                if (currentTicker) {
                    seleccionarValor(currentTicker);
                }
                
            } catch (error) {
                console.error('Error calculando activo:', error);
            }
        }

        function renderTopValores(data) {
            const container = document.getElementById('top-valores-grid');
            const top10 = data.slice(0, 10);
            
            container.innerHTML = top10.map((item, i) => `
                <div class="top-valor-card ${item.activo.ticker === state.tickerActivo ? 'selected' : ''}" 
                     onclick="seleccionarValor('${item.activo.ticker}')">
                    <div class="top-valor-rank">${i + 1}</div>
                    <div class="top-valor-info">
                        <span class="top-valor-nombre">${item.activo.nombre}</span>
                        <span class="top-valor-sector">${item.activo.sector}</span>
                    </div>
                    <div class="top-valor-yield">
                        <span class="yield-value">${item.dividendos.yield}</span>
                        <span class="consistencia-badge ${item.dividendos.consistencia.toLowerCase()}">${item.dividendos.consistencia}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderRankingTable(data) {
            const tbody = document.getElementById('ranking-tbody');
            
            tbody.innerHTML = data.map((item, i) => `
                <tr class="${item.activo.ticker === state.tickerActivo ? 'selected' : ''}"
                    onclick="seleccionarValor('${item.activo.ticker}')" style="cursor: pointer;">
                    <td>${i + 1}</td>
                    <td>
                        <strong>${item.activo.nombre}</strong><br>
                        <small>${item.activo.ticker}</small>
                    </td>
                    <td>${item.activo.sector}</td>
                    <td class="yield-cell">${item.dividendos.yield}</td>
                    <td class="${parseFloat(item.dividendos.crecimiento_cagr) > 0 ? 'positive' : 'negative'}">${item.dividendos.crecimiento_cagr}</td>
                    <td><span class="consistencia-badge ${item.dividendos.consistencia.toLowerCase()}">${item.dividendos.consistencia}</span></td>
                    <td>${item.riesgo.ltv_recomendado}</td>
                    <td>${formatCurrency(item.para_lombardo.prestamo_maximo)}</td>
                </tr>
            `).join('');
        }

        async function seleccionarValor(ticker) {
            state.tickerActivo = ticker;
            
            try {
                const response = await fetch(`api/activos/analizar/${ticker}?inversion=${state.capitalInicial}`);
                const data = await response.json();
                
                // Update state
                state.yieldActivo = data.dividendos.yield_valor / 100;
                
                // Update UI
                document.getElementById('activo-nombre').textContent = data.activo.nombre;
                document.getElementById('activo-ticker').textContent = data.activo.ticker;
                document.getElementById('activo-precio').textContent = data.activo.precio.toFixed(2) + ' ‚Ç¨';
                document.getElementById('activo-acciones').textContent = formatNumber(data.inversion.num_acciones);
                document.getElementById('activo-sector').textContent = data.activo.sector;
                
                document.getElementById('activo-yield').textContent = data.dividendos.yield;
                document.getElementById('dividendos-anuales').textContent = formatCurrency(data.dividendos.total_anual);
                document.getElementById('dividendo-accion').textContent = data.dividendos.dividendo_ultimo.toFixed(2) + ' ‚Ç¨';
                document.getElementById('dividendos-mensuales').textContent = formatCurrency(data.dividendos.total_mensual);
                document.getElementById('dividendo-cagr').textContent = data.dividendos.crecimiento_cagr;
                document.getElementById('dividendo-consistencia').textContent = data.dividendos.consistencia;
                document.getElementById('dividendo-consistencia').className = `consistencia-badge ${data.dividendos.consistencia.toLowerCase()}`;
                
                document.getElementById('activo-volatilidad').textContent = data.riesgo.volatilidad;
                document.getElementById('activo-beta').textContent = data.riesgo.beta;
                document.getElementById('activo-drawdown').textContent = data.riesgo.max_drawdown_5y;
                document.getElementById('activo-ltv-rec').textContent = data.riesgo.ltv_recomendado;
                
                document.getElementById('prestamo-maximo').textContent = formatCurrency(data.para_lombardo.prestamo_maximo);
                document.getElementById('margen-seguridad').textContent = data.para_lombardo.margen_seguridad;
                
                // Update visual selection
                document.querySelectorAll('.top-valor-card').forEach(card => {
                    card.classList.toggle('selected', card.onclick.toString().includes(ticker));
                });
                document.querySelectorAll('#ranking-tbody tr').forEach(row => {
                    row.classList.toggle('selected', row.onclick.toString().includes(ticker));
                });
                
                // Render dividends chart
                renderDividendosChart(data.dividendos.historico, data.dividendos.a√±os, data.activo.nombre);
                
                // Recalcular estrategia
                calcularEstrategia();
                
            } catch (error) {
                console.error('Error seleccionando valor:', error);
            }
        }

        function renderDividendosChart(historico, a√±os, nombre) {
            const ctx = document.getElementById('dividendos-chart').getContext('2d');
            
            if (charts.dividendos) {
                charts.dividendos.destroy();
            }
            
            charts.dividendos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: a√±os,
                    datasets: [{
                        label: 'Dividendo (‚Ç¨/acci√≥n)',
                        data: historico,
                        backgroundColor: historico.map((v, i) => {
                            if (i === 0) return 'rgba(245, 158, 11, 0.6)';
                            const prev = historico[i-1];
                            if (v > prev) return 'rgba(34, 197, 94, 0.8)';
                            if (v < prev) return 'rgba(239, 68, 68, 0.8)';
                            return 'rgba(245, 158, 11, 0.6)';
                        }),
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `${nombre} - Dividendos por acci√≥n`,
                            color: '#fff',
                            font: { size: 14 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw.toFixed(2)} ‚Ç¨/acci√≥n`
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            ticks: { 
                                color: '#888',
                                callback: (val) => val.toFixed(2) + ' ‚Ç¨'
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        async function cargarRanking() {
            // Esta funci√≥n ahora se llama desde calcularActivo
            // Mantenida por compatibilidad
        }

        // ====================================
        // ESTUDIO 3: INVERSI√ìN
        // ====================================
        async function calcularInversion() {
            try {
                const costePrestamo = state.euribor + state.spreadLombardo;
                const capitalPrestamo = state.capitalInicial * state.ltv;
                
                const params = new URLSearchParams({
                    capital_prestamo: capitalPrestamo,
                    coste_prestamo: costePrestamo,
                    perfil: 'moderado'
                });
                
                const response = await fetch(`api/inversion/opciones?${params}`);
                const data = await response.json();
                
                // Update minimum
                document.getElementById('coste-referencia').textContent = (costePrestamo * 100).toFixed(2) + '%';
                document.getElementById('minimo-rentable').textContent = (costePrestamo * 100).toFixed(2) + '%';
                
                // Update options
                const container = document.getElementById('opciones-inversion');
                container.innerHTML = data.todas_las_opciones.map(op => `
                    <div class="opcion-card ${op.conclusion.es_rentable ? 'rentable' : 'no-rentable'}"
                         onclick="seleccionarInversion('${op.key}', ${parseFloat(op.numeros.rentabilidad_esperada.replace('%', '')) / 100})">
                        <div class="opcion-header">
                            <span class="opcion-nombre">${op.opcion.nombre}</span>
                            <span class="opcion-veredicto">${op.conclusion.veredicto}</span>
                        </div>
                        <div class="opcion-body">
                            <div class="opcion-stat">
                                <span class="stat-label">Rentabilidad</span>
                                <span class="stat-value">${op.numeros.rentabilidad_esperada}</span>
                            </div>
                            <div class="opcion-stat">
                                <span class="stat-label">Spread</span>
                                <span class="stat-value ${parseFloat(op.numeros.spread.replace('%', '')) > 0 ? 'positive' : 'negative'}">${op.numeros.spread}</span>
                            </div>
                            <div class="opcion-stat">
                                <span class="stat-label">Beneficio/a√±o</span>
                                <span class="stat-value">${formatCurrency(op.numeros.beneficio_neto_anual)}</span>
                            </div>
                        </div>
                        <div class="opcion-footer">
                            <span class="opcion-riesgo">${op.opcion.riesgo}</span>
                            <span class="opcion-liquidez">${op.opcion.liquidez}</span>
                        </div>
                    </div>
                `).join('');
                
                // Load scenarios chart
                await cargarEscenarios();
                
            } catch (error) {
                console.error('Error calculando inversi√≥n:', error);
            }
        }

        function seleccionarInversion(key, rentabilidad) {
            state.rentabilidadInversion = rentabilidad;
            
            // Update selection visual
            document.querySelectorAll('.opcion-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            calcularEstrategia();
        }

        async function cargarEscenarios() {
            try {
                const capitalPrestamo = state.capitalInicial * state.ltv;
                const response = await fetch(`api/inversion/escenarios?capital=${capitalPrestamo}`);
                const escenarios = await response.json();
                
                const ctx = document.getElementById('escenarios-chart').getContext('2d');
                
                if (charts.escenarios) {
                    charts.escenarios.destroy();
                }
                
                charts.escenarios = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: escenarios.map(e => e.coste_prestamo),
                        datasets: [{
                            label: 'Beneficio Anual',
                            data: escenarios.map(e => e.beneficio_anual),
                            backgroundColor: escenarios.map(e => 
                                e.es_rentable ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'
                            ),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => formatCurrency(ctx.raw)
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Coste del Pr√©stamo (TAE)' }
                            },
                            y: {
                                title: { display: true, text: 'Beneficio Anual (‚Ç¨)' },
                                ticks: {
                                    callback: (val) => formatCurrency(val)
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error cargando escenarios:', error);
            }
        }

        // ====================================
        // COMPARATIVA HIPOTECA
        // ====================================
        async function calcularComparativa() {
            try {
                const capitalPrestamo = state.capitalInicial * state.ltv;
                
                const params = new URLSearchParams({
                    capital: capitalPrestamo,
                    hipoteca_plazo: 25,
                    hipoteca_spread: 0.01,
                    lombardo_ltv: state.ltv,
                    lombardo_spread: state.spreadLombardo,
                    euribor: state.euribor
                });
                
                const response = await fetch(`api/comparar/hipoteca-lombardo?${params}`);
                const data = await response.json();
                
                document.getElementById('hipoteca-tin').textContent = data.hipoteca.tin;
                document.getElementById('hipoteca-cuota').textContent = formatCurrency(data.hipoteca.cuota_mensual);
                document.getElementById('hipoteca-gastos').textContent = formatCurrency(data.hipoteca.gastos_iniciales);
                
            } catch (error) {
                console.error('Error calculando comparativa:', error);
            }
        }

        // ====================================
        // ESTRATEGIA COMPLETA
        // ====================================
        async function calcularEstrategia() {
            try {
                const params = new URLSearchParams({
                    capital_inicial: state.capitalInicial,
                    yield_activo: state.yieldActivo,
                    ltv: state.ltv,
                    coste_prestamo: state.euribor + state.spreadLombardo,
                    rentabilidad_inversion: state.rentabilidadInversion,
                    a√±os: 5
                });
                
                const response = await fetch(`api/estrategia/simulador?${params}`);
                const data = await response.json();
                
                // Update flow
                document.getElementById('flow-capital').textContent = formatCurrency(state.capitalInicial);
                document.getElementById('flow-prestamo').textContent = formatCurrency(state.capitalInicial * state.ltv);
                document.getElementById('flow-inversion').textContent = formatCurrency(state.capitalInicial * state.ltv);
                
                // Update results
                const proyeccion = data.proyeccion;
                const ultimo = proyeccion[0]; // Primer a√±o
                
                document.getElementById('resultado-dividendos').textContent = '+' + formatCurrency(ultimo.dividendos);
                document.getElementById('resultado-rentabilidad').textContent = '+' + formatCurrency(ultimo.rentabilidad_inversion);
                document.getElementById('resultado-ingresos').textContent = '+' + formatCurrency(ultimo.dividendos + ultimo.rentabilidad_inversion);
                document.getElementById('resultado-coste').textContent = '-' + formatCurrency(ultimo.coste_prestamo);
                document.getElementById('resultado-gastos').textContent = '-' + formatCurrency(ultimo.coste_prestamo);
                
                const beneficioNeto = ultimo.beneficio_a√±o;
                const isPositive = beneficioNeto >= 0;
                const resultadoNetoEl = document.getElementById('resultado-neto');
                resultadoNetoEl.textContent = (isPositive ? '+' : '') + formatCurrency(beneficioNeto);
                resultadoNetoEl.className = 'final-value ' + (isPositive ? 'positive' : 'negative');
                
                document.getElementById('resultado-roi').textContent = (ultimo.roi_a√±o * 100).toFixed(2) + '%';
                document.getElementById('resultado-sin-apalancamiento').textContent = (state.yieldActivo * 100).toFixed(2) + '%';
                
                const mejora = ultimo.roi_a√±o - state.yieldActivo;
                document.getElementById('resultado-mejora').textContent = (mejora >= 0 ? '+' : '') + (mejora * 100).toFixed(2) + '%';
                
                // 5 year summary
                const ultimoA√±o = proyeccion[proyeccion.length - 1];
                document.getElementById('beneficio-5-a√±os').textContent = formatCurrency(ultimoA√±o.beneficio_acumulado);
                document.getElementById('roi-5-a√±os').textContent = (ultimoA√±o.roi_acumulado * 100).toFixed(2) + '%';
                document.getElementById('roi-anualizado').textContent = data.resumen.roi_anualizado;
                
                // Update chart
                const ctx = document.getElementById('proyeccion-chart').getContext('2d');
                
                if (charts.proyeccion) {
                    charts.proyeccion.destroy();
                }
                
                charts.proyeccion = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: proyeccion.map(p => `A√±o ${p.a√±o}`),
                        datasets: [
                            {
                                label: 'Beneficio Acumulado',
                                data: proyeccion.map(p => p.beneficio_acumulado),
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Ingresos (Dividendos + Inversi√≥n)',
                                data: proyeccion.map(p => p.dividendos + p.rentabilidad_inversion),
                                borderColor: 'rgb(59, 130, 246)',
                                borderDash: [5, 5],
                                tension: 0.3
                            },
                            {
                                label: 'Coste Pr√©stamo',
                                data: proyeccion.map(p => p.coste_prestamo),
                                borderColor: 'rgb(239, 68, 68)',
                                borderDash: [5, 5],
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: (val) => formatCurrency(val)
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error calculando estrategia:', error);
            }
        }

        // ====================================
        // UTILITIES
        // ====================================
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('es-ES', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
    </script>
</body>
</html>


